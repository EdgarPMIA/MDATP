//query DeviceEvents and DeviceAlertEvents tables for all occurrences of Malware
//joins both tables so output shows all malware detections from both AV and Threat Intelligence
//use to create PowerBI reports, etc.
//jesse.esquivel@microsoft.com
let AVDetections = DeviceEvents
    | where ActionType == 'AntivirusDetection'
    | extend ParseJson = parsejson(AdditionalFields) 
    | extend ThreatName = ParseJson.ThreatName 
    | extend WasExeWhileDetected = ParseJson.WasExecutingWhileDetected
    | extend Remediated = ParseJson.WasRemediated
    | extend ResourceSchema = ParseJson.ResourceSchema
    | extend ReportSource = ParseJson.ReportSource
    | project Timestamp, DeviceId, DeviceName, ThreatName, ReportSource, WasExeWhileDetected, Remediated, ResourceSchema, 
        ActionType, FileName, FolderPath, SHA1, MD5, AdditionalFields, InitiatingProcessFolderPath, InitiatingProcessId;
DeviceAlertEvents
| where Category == "Malware"
| join kind = inner(AVDetections) on FileName
| summarize arg_max(FileName, *) by Timestamp
| project Timestamp, DeviceId, DeviceName, ThreatName, ReportSource, Title, WasExeWhileDetected, Remediated, ResourceSchema,
        ActionType, FileName, FolderPath, SHA1, MD5, AdditionalFields, InitiatingProcessFolderPath, InitiatingProcessId
